<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Integra√ß√£o - Gaze Detection com Landmarks</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            color: #6c757d;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .video-container {
            margin: 20px 0;
            text-align: center;
            position: relative;
        }
        video {
            max-width: 100%;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 8px;
        }
        .landmarks-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .focus-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        .focus-excellent { background: #28a745; }
        .focus-good { background: #17a2b8; }
        .focus-moderate { background: #ffc107; color: #212529; }
        .focus-low { background: #fd7e14; }
        .focus-critical { background: #dc3545; }
        .landmarks-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste de Integra√ß√£o - Gaze Detection com Landmarks</h1>

        <div class="status disconnected" id="connectionStatus">
            üî¥ Desconectado
        </div>

        <div class="metrics" id="metrics" style="display: none;">
            <div class="metric-card">
                <div class="metric-value" id="gazeH">-</div>
                <div class="metric-label">Gaze Horizontal</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="gazeV">-</div>
                <div class="metric-label">Gaze Vertical</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="attention">-</div>
                <div class="metric-label">Aten√ß√£o</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="onScreen">-</div>
                <div class="metric-label">Na Tela</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="pitch">-</div>
                <div class="metric-label">Pitch (Vertical)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="yaw">-</div>
                <div class="metric-label">Yaw (Horizontal)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="gazeDirection">-</div>
                <div class="metric-label">Dire√ß√£o do Olhar</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="focusLevel">-</div>
                <div class="metric-label">N√≠vel de Foco</div>
            </div>
        </div>

        <div class="landmarks-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff0000;"></div>
                <span>Olho Esquerdo (pontos 33, 133, 159, 145)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00ff00;"></div>
                <span>Olho Direito (pontos 362, 263, 386, 374)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #0000ff;"></div>
                <span>√çris Esquerda (pontos 468, 469, 470, 471)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff00ff;"></div>
                <span>√çris Direita (pontos 473, 474, 475, 476)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00ffff;"></div>
                <span>Nariz (ponto 4)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffff00;"></div>
                <span>Orelhas (pontos 234, 454)</span>
            </div>
        </div>

        <div class="video-container">
            <video id="video" autoplay playsinline muted style="display: none;"></video>
            <canvas id="landmarksCanvas" style="display: none;"></canvas>
            <div id="videoPlaceholder">
                <p>Clique em "Iniciar C√¢mera" para come√ßar</p>
            </div>
            <div id="focusIndicator" class="focus-indicator" style="display: none;">
                FOCO: EXCELENTE
            </div>
        </div>

        <div class="landmarks-info" id="landmarksInfo" style="display: none;">
            <strong>üéØ LANDMARKS DETECTADOS:</strong><br>
            <span id="landmarksText">Aguardando detec√ß√£o...</span>
        </div>

        <div class="landmarks-info" id="toleranceInfo" style="display: block;">
            <strong>üéØ CONFIGURA√á√ÉO REALISTA:</strong><br>
            <span>‚Ä¢ Gaze threshold: 0.8 (era 2.0) - Mais realista e responsivo</span><br>
            <span>‚Ä¢ Attention min: 0.3 (era 0.05) - Considera "Na Tela" com thresholds realistas</span><br>
            <span>‚Ä¢ Focus levels: Excelente(80%), Bom(60%), Moderado(40%), Baixo(20%)</span><br>
            <span>‚Ä¢ Detec√ß√£o robusta da posi√ß√£o dos olhos</span><br>
            <span>‚Ä¢ BBox da face inclu√≠do</span>
        </div>

        <div style="text-align: center;">
            <button id="startCamera" onclick="startCamera()">üìπ Iniciar C√¢mera</button>
            <button id="stopCamera" onclick="stopCamera()" disabled>‚èπÔ∏è Parar C√¢mera</button>
            <button id="connectGaze" onclick="connectGaze()" disabled>üîå Conectar Gaze</button>
            <button id="disconnectGaze" onclick="disconnectGaze()" disabled>üîå Desconectar Gaze</button>
            <button id="toggleLandmarks" onclick="toggleLandmarks()" disabled>üëÅÔ∏è Toggle Landmarks</button>
        </div>

        <div id="logs" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
            <div>üìù Logs de teste aparecer√£o aqui...</div>
        </div>
    </div>

    <script>
        let cameraStream = null;
        let gazeWebSocket = null;
        let isConnected = false;
        let isMonitoring = false;
        let showLandmarks = true;
        let landmarksData = null;

        // Canvas para desenhar landmarks
        const video = document.getElementById('video');
        const canvas = document.getElementById('landmarksCanvas');
        const ctx = canvas.getContext('2d');

        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status ${status}`;
            statusEl.innerHTML = message;
        }

        function updateMetrics(data) {
            if (data.gaze) {
                document.getElementById('gazeH').textContent = data.gaze.h.toFixed(3);
                document.getElementById('gazeV').textContent = data.gaze.v.toFixed(3);
            }
            if (data.attention !== undefined) {
                document.getElementById('attention').textContent = (data.attention * 100).toFixed(1) + '%';
            }
            if (data.on_screen !== undefined) {
                document.getElementById('onScreen').textContent = data.on_screen ? 'Sim' : 'N√£o';
            }
            
            // Novas m√©tricas robustas
            if (data.angles) {
                document.getElementById('pitch').textContent = data.angles.pitch_deg.toFixed(1) + "¬∞";
                document.getElementById('yaw').textContent = data.angles.yaw_deg.toFixed(1) + "¬∞";
            }
            if (data.gaze_direction !== undefined) {
                document.getElementById('gazeDirection').textContent = data.gaze_direction;
            }
            if (data.focus_level !== undefined) {
                document.getElementById('focusLevel').textContent = data.focus_level;
            }
            
            // Log das m√©tricas para debug
            if (data.thresholds) {
                log(`üéØ Thresholds: Gaze=${data.thresholds.gaze_limit}, Attention=${data.thresholds.attention_min}`);
            }
            if (data.distance_from_center !== undefined) {
                log(`üìè Dist√¢ncia do centro: ${data.distance_from_center.toFixed(3)}`);
            }
            if (data.face_bbox) {
                log(`üì¶ Face BBox: x=${data.face_bbox.x.toFixed(3)}, y=${data.face_bbox.y.toFixed(3)}, w=${data.face_bbox.w.toFixed(3)}, h=${data.face_bbox.h.toFixed(3)}`);
            }

            // Atualizar indicador de foco
            updateFocusIndicator(data.attention);
        }

        function updateFocusIndicator(attention) {
            const indicator = document.getElementById('focusIndicator');
            if (!indicator) return;

            let level, text, className;

            if (attention >= 0.9) {
                level = 'EXCELENTE';
                text = 'FOCO: EXCELENTE';
                className = 'focus-excellent';
            } else if (attention >= 0.8) {
                level = 'BOM';
                text = 'FOCO: BOM';
                className = 'focus-good';
            } else if (attention >= 0.7) {
                level = 'MODERADO';
                text = 'FOCO: MODERADO';
                className = 'focus-moderate';
            } else if (attention >= 0.5) {
                level = 'BAIXO';
                text = 'FOCO: BAIXO';
                className = 'focus-low';
            } else {
                level = 'CR√çTICO';
                text = 'FOCO: CR√çTICO';
                className = 'focus-critical';
            }

            indicator.textContent = text;
            indicator.className = `focus-indicator ${className}`;
            indicator.style.display = 'block';
        }

        function drawLandmarks(landmarks) {
            if (!showLandmarks || !landmarks) return;

            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;

            if (videoWidth === 0 || videoHeight === 0) return;

            // Configurar canvas
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            canvas.style.width = video.offsetWidth + 'px';
            canvas.style.height = video.offsetHeight + 'px';

            // Limpar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Definir pontos importantes para gaze
            const LEFT_EYE = [33, 133, 159, 145];
            const RIGHT_EYE = [362, 263, 386, 374];
            const LEFT_IRIS = [468, 469, 470, 471];
            const RIGHT_IRIS = [473, 474, 475, 476];
            const NOSE_TIP = 4;
            const LEFT_EAR = 234;
            const RIGHT_EAR = 454;

            // Desenhar todos os pontos do rosto (pequenos)
            ctx.fillStyle = 'rgba(100, 100, 100, 0.5)';
            for (let i = 0; i < landmarks.length; i++) {
                const landmark = landmarks[i];
                const x = landmark.x * videoWidth;
                const y = landmark.y * videoHeight;
                ctx.beginPath();
                ctx.arc(x, y, 1, 0, 2 * Math.PI);
                ctx.fill();
            }

            // Desenhar pontos importantes com cores diferentes
            const colors = {
                'left_eye': '#ff0000',      // Vermelho
                'right_eye': '#00ff00',     // Verde
                'left_iris': '#0000ff',     // Azul
                'right_iris': '#ff00ff',    // Magenta
                'nose': '#00ffff',          // Ciano
                'ears': '#ffff00'           // Amarelo
            };

            // Fun√ß√£o para desenhar pontos espec√≠ficos
            function drawPoints(indices, color, size = 3) {
                ctx.fillStyle = color;
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;

                for (const idx of indices) {
                    if (idx < landmarks.length) {
                        const landmark = landmarks[idx];
                        const x = landmark.x * videoWidth;
                        const y = landmark.y * videoHeight;

                        // C√≠rculo preenchido
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, 2 * Math.PI);
                        ctx.fill();

                        // Borda branca
                        ctx.stroke();

                        // N√∫mero do ponto
                        ctx.fillStyle = 'white';
                        ctx.font = '8px Arial';
                        ctx.fillText(idx.toString(), x + 5, y - 5);
                        ctx.fillStyle = color;
                    }
                }
            }

            // Desenhar pontos espec√≠ficos
            drawPoints(LEFT_EYE, colors.left_eye, 3);
            drawPoints(RIGHT_EYE, colors.right_eye, 3);
            drawPoints(LEFT_IRIS, colors.left_iris, 4);
            drawPoints(RIGHT_IRIS, colors.right_iris, 4);
            drawPoints([NOSE_TIP], colors.nose, 5);
            drawPoints([LEFT_EAR, RIGHT_EAR], colors.ears, 4);

            // Desenhar seta de gaze se dispon√≠vel
            if (landmarksData && landmarksData.gaze) {
                const centerX = videoWidth / 2;
                const centerY = videoHeight / 2;
                const gazeX = centerX + landmarksData.gaze.h * 100;
                const gazeY = centerY + landmarksData.gaze.v * 100;

                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(gazeX, gazeY);
                ctx.stroke();

                // Cabe√ßa da seta
                ctx.fillStyle = '#00ffff';
                ctx.beginPath();
                ctx.arc(gazeX, gazeY, 5, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // Desenhar BBox da face (se dispon√≠vel)
            if (landmarksData && landmarksData.face_bbox) {
                const bbox = landmarksData.face_bbox;
                
                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);
                
                const x = bbox.x * videoWidth;
                const y = bbox.y * videoHeight;
                const w = bbox.w * videoWidth;
                const h = bbox.h * videoHeight;
                
                ctx.strokeRect(x, y, w, h);
                ctx.setLineDash([]);
                
                // Adicionar texto "FACE"
                ctx.fillStyle = '#00ffff';
                ctx.font = 'bold 14px Arial';
                ctx.fillText('FACE', x + 5, y - 5);
            }

            // Atualizar informa√ß√µes dos landmarks
            updateLandmarksInfo(landmarks);
        }

        function updateLandmarksInfo(landmarks) {
            const infoEl = document.getElementById('landmarksInfo');
            const textEl = document.getElementById('landmarksText');

            if (!landmarks || landmarks.length === 0) {
                textEl.textContent = 'Nenhum landmark detectado';
                return;
            }

            const info = [
                `Total de pontos: ${landmarks.length}`,
                `Olho Esquerdo: (${landmarks[33]?.x?.toFixed(3)}, ${landmarks[33]?.y?.toFixed(3)})`,
                `Olho Direito: (${landmarks[362]?.x?.toFixed(3)}, ${landmarks[362]?.y?.toFixed(3)})`,
                `√çris Esquerda: (${landmarks[468]?.x?.toFixed(3)}, ${landmarks[468]?.y?.toFixed(3)})`,
                `√çris Direita: (${landmarks[473]?.x?.toFixed(3)}, ${landmarks[473]?.y?.toFixed(3)})`,
                `Nariz: (${landmarks[4]?.x?.toFixed(3)}, ${landmarks[4]?.y?.toFixed(3)})`
            ].join('<br>');

            textEl.innerHTML = info;
            infoEl.style.display = 'block';
        }

        function toggleLandmarks() {
            showLandmarks = !showLandmarks;
            const button = document.getElementById('toggleLandmarks');
            button.textContent = showLandmarks ? 'üëÅÔ∏è Ocultar Landmarks' : 'üëÅÔ∏è Mostrar Landmarks';

            if (!showLandmarks) {
                // Limpar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            log(`Landmarks ${showLandmarks ? 'ativados' : 'desativados'}`);
        }

        async function startCamera() {
            try {
                log('üé• Iniciando c√¢mera...');
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 640 }, height: { ideal: 480 } }
                });

                video.srcObject = cameraStream;
                video.style.display = 'block';
                canvas.style.display = 'block';
                document.getElementById('videoPlaceholder').style.display = 'none';

                document.getElementById('startCamera').disabled = true;
                document.getElementById('stopCamera').disabled = false;
                document.getElementById('connectGaze').disabled = false;
                document.getElementById('toggleLandmarks').disabled = false;

                log('‚úÖ C√¢mera iniciada com sucesso');
                updateConnectionStatus('connected', 'üìπ C√¢mera ativa');

            } catch (error) {
                log(`‚ùå Erro ao iniciar c√¢mera: ${error.message}`);
                updateConnectionStatus('disconnected', '‚ùå Erro na c√¢mera');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;

                video.style.display = 'none';
                canvas.style.display = 'none';
                document.getElementById('videoPlaceholder').style.display = 'block';
                document.getElementById('focusIndicator').style.display = 'none';

                document.getElementById('startCamera').disabled = false;
                document.getElementById('stopCamera').disabled = true;
                document.getElementById('connectGaze').disabled = true;
                document.getElementById('disconnectGaze').disabled = true;
                document.getElementById('toggleLandmarks').disabled = true;

                log('‚èπÔ∏è C√¢mera parada');
                updateConnectionStatus('disconnected', 'üî¥ C√¢mera inativa');
            }
        }

        async function connectGaze() {
            if (!cameraStream) {
                log('‚ùå C√¢mera n√£o est√° ativa');
                return;
            }

            try {
                log('üîå Conectando ao backend de gaze...');
                updateConnectionStatus('connecting', 'üü° Conectando...');

                const sessionId = `test_${Date.now()}`;
                const wsUrl = `ws://localhost:8000/gaze/ws/${sessionId}`;

                gazeWebSocket = new WebSocket(wsUrl);

                gazeWebSocket.onopen = () => {
                    log('‚úÖ Conectado ao WebSocket de gaze');
                    isConnected = true;
                    updateConnectionStatus('connected', 'üü¢ Gaze conectado');
                    document.getElementById('disconnectGaze').disabled = false;
                    document.getElementById('connectGaze').disabled = true;

                    // Iniciar monitoramento
                    startGazeMonitoring();
                };

                gazeWebSocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì• Dados recebidos: ${JSON.stringify(data)}`);

                        if (data.type === 'focus_alert') {
                            log('üö® ALERTA DE PERDA DE FOCO!');
                        } else if (data.gaze) {
                            updateMetrics(data);
                            document.getElementById('metrics').style.display = 'grid';

                            // Armazenar dados para desenhar seta de gaze
                            landmarksData = data;
                            
                            // Log adicional para debug
                            if (data.face_bbox) {
                                log(`üì¶ Face BBox recebido: ${JSON.stringify(data.face_bbox)}`);
                            }
                        }

                    } catch (error) {
                        log(`‚ùå Erro ao processar mensagem: ${error.message}`);
                    }
                };

                gazeWebSocket.onerror = (error) => {
                    log(`‚ùå Erro no WebSocket: ${error}`);
                    updateConnectionStatus('disconnected', '‚ùå Erro na conex√£o');
                };

                gazeWebSocket.onclose = () => {
                    log('üîå WebSocket desconectado');
                    isConnected = false;
                    isMonitoring = false;
                    updateConnectionStatus('disconnected', 'üî¥ Gaze desconectado');
                    document.getElementById('disconnectGaze').disabled = true;
                    document.getElementById('connectGaze').disabled = false;
                };

            } catch (error) {
                log(`‚ùå Erro ao conectar: ${error.message}`);
                updateConnectionStatus('disconnected', '‚ùå Erro na conex√£o');
            }
        }

        function startGazeMonitoring() {
            if (!isConnected || !cameraStream) return;

            log('üëÅÔ∏è Iniciando monitoramento de gaze...');
            isMonitoring = true;

            // Capturar frames da c√¢mera e enviar para o backend
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const sendFrame = () => {
                if (!isMonitoring || !isConnected) return;

                try {
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((blob) => {
                        if (blob && gazeWebSocket && gazeWebSocket.readyState === WebSocket.OPEN) {
                            const reader = new FileReader();
                            reader.onload = () => {
                                const base64 = reader.result.split(',')[1];
                                const message = {
                                    type: 'frame',
                                    data: base64,
                                    timestamp: Date.now()
                                };
                                gazeWebSocket.send(JSON.stringify(message));
                            };
                            reader.readAsDataURL(blob);
                        }
                    }, 'image/jpeg', 0.8);
                } catch (error) {
                    log(`‚ùå Erro ao capturar frame: ${error.message}`);
                }

                // Enviar frame a cada 100ms (10 FPS)
                setTimeout(sendFrame, 100);
            };

            sendFrame();
        }

        function disconnectGaze() {
            if (gazeWebSocket) {
                gazeWebSocket.close();
                gazeWebSocket = null;
            }
            isConnected = false;
            isMonitoring = false;
            log('üîå Gaze desconectado');
        }

        // Simular landmarks para demonstra√ß√£o (quando n√£o h√° dados reais)
        function simulateLandmarks() {
            if (!showLandmarks || !video.videoWidth) return;

            const mockLandmarks = [];
            const numPoints = 468;

            for (let i = 0; i < numPoints; i++) {
                mockLandmarks.push({
                    x: 0.5 + (Math.random() - 0.5) * 0.1,
                    y: 0.5 + (Math.random() - 0.5) * 0.1
                });
            }

            // Ajustar pontos espec√≠ficos para parecer realista
            mockLandmarks[33] = { x: 0.4, y: 0.4 };  // Olho esquerdo
            mockLandmarks[362] = { x: 0.6, y: 0.4 }; // Olho direito
            mockLandmarks[468] = { x: 0.4, y: 0.4 }; // √çris esquerda
            mockLandmarks[473] = { x: 0.6, y: 0.4 }; // √çris direita
            mockLandmarks[4] = { x: 0.5, y: 0.5 };   // Nariz

            drawLandmarks(mockLandmarks);
        }

        // Loop para simular landmarks quando n√£o h√° dados reais
        setInterval(() => {
            if (cameraStream && !landmarksData) {
                simulateLandmarks();
            }
        }, 1000);

        // Limpar recursos ao sair
        window.addEventListener('beforeunload', () => {
            if (cameraStream) stopCamera();
            if (gazeWebSocket) disconnectGaze();
        });

        log('üöÄ P√°gina de teste carregada. Backend deve estar rodando em localhost:8000');
        log('üí° Use "Toggle Landmarks" para mostrar/ocultar os pontos do rosto');
    </script>
</body>
</html>
